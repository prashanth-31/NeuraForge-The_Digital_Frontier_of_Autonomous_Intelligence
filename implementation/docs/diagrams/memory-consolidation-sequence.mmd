%% Memory Consolidation Sequence Diagram
%% Render with: mmdc -i memory-consolidation-sequence.mmd -o memory-consolidation-sequence.png

%%{init: {"theme": "base", "sequence": {"useMaxWidth": true}} }%%
sequenceDiagram
    participant Scheduler as Consolidation Scheduler
    participant Redis as Redis (Working Memory)
    participant Postgres as PostgreSQL (Episodic)
    participant Qdrant as Qdrant (Semantic)
    participant Summarizer as Summarization Agent

    Scheduler->>Redis: Fetch recent task states
    Redis-->>Scheduler: Key/value window
    Scheduler->>Postgres: Fetch task transcripts
    Postgres-->>Scheduler: Full conversation logs
    Scheduler->>Summarizer: Build summary prompt
    Summarizer-->>Scheduler: Consolidated synopsis
    Scheduler->>Qdrant: Upsert embedding & payload
    Qdrant-->>Scheduler: Ack vector stored
    Scheduler->>Redis: Drop expired keys
    Scheduler->>Postgres: Mark episodes consolidated

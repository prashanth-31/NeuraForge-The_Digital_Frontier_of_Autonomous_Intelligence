groups:
  - name: orchestrator-observability
    interval: 30s
    rules:
      - record: orchestrator:throughput_per_minute
        expr: rate(neuraforge_orchestrator_runs_total{status="completed"}[5m]) * 60
      - record: orchestrator:success_rate
        expr: |
          sum(rate(neuraforge_orchestrator_runs_total{status="completed"}[15m])) /
          clamp_min(sum(rate(neuraforge_orchestrator_runs_total[15m])), 1e-6)
      - alert: OrchestratorHighFailureRate
        expr: |
          sum(rate(neuraforge_orchestrator_runs_total{status!="completed"}[10m])) /
          clamp_min(sum(rate(neuraforge_orchestrator_runs_total[10m])), 1e-6) > 0.3
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Failure rate above 30%"
          description: "More than 30% of orchestrator runs failed or were cancelled in the last 10 minutes."

      - alert: TaskLatencyWarning
        expr: |
          histogram_quantile(
            0.95,
            sum by (le, agent_count) (
              rate(neuraforge_task_latency_seconds_bucket{entry_point="api"}[5m])
            )
          ) > 45
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Task p95 latency above 45s"
          description: "Task latency p95 across API entry point exceeded 45 seconds for the last 10 minutes."

      - alert: TaskLatencyCritical
        expr: |
          histogram_quantile(
            0.95,
            sum by (le, agent_count) (
              rate(neuraforge_task_latency_seconds_bucket{entry_point="api"}[5m])
            )
          ) > 60
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Task p95 latency above 60s"
          description: "Task latency p95 across API entry point exceeded 60 seconds for the last 10 minutes."

      - alert: GuardrailEscalationSpike
        expr: max(sum by (policy_id) (increase(neuraforge_guardrail_decision_total{decision="escalate"}[15m]))) > 3
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Guardrail escalations exceeding threshold"
          description: "A guardrail policy generated more than three escalations in the last 15 minutes."

      - alert: GuardrailDenyCritical
        expr: max(sum by (policy_id) (increase(neuraforge_guardrail_decision_total{decision="deny"}[15m]))) >= 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Guardrail deny triggered"
          description: "At least one guardrail deny decision occurred in the last 15 minutes. Engage safety lead."
      - alert: NegotiationConsensusDegradation
        expr: histogram_quantile(0.5, sum(rate(neuraforge_negotiation_consensus_bucket[15m])) by (le)) < 0.4
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Median negotiation consensus dropping"
          description: "Median negotiation consensus fell below 0.4 in the last 15 minutes."
      - alert: MetaAgentDisputeSpike
        expr: rate(neuraforge_meta_agent_disputes_total[10m]) > 3
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Meta-agent dispute volume elevated"
          description: "Meta-agent flagged more than three disputes per minute over the last 10 minutes."
      - alert: MetaResolutionLatencySLO
        expr: histogram_quantile(0.95, sum(rate(neuraforge_meta_agent_resolution_latency_seconds_bucket[15m])) by (le)) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Meta-agent resolution latency above target"
          description: "Meta-agent p95 latency exceeded 5 seconds for the past 15 minutes."
